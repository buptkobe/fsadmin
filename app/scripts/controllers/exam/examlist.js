"use strict";angular.module("sbAdminApp").controller("ExamListCtrl",function($window,$scope,$location,LevelFactory,ShareFactory,UserFactory,ExamFactory,$state,toastr,$filter,$timeout,ExamSettingFactory){var vm=$scope.vm={};vm.holdon=1e3,vm.index=0,vm.size=20,vm.begin=!0,vm.score=0,vm.exam=!1,vm.end=!1,vm.itype=1,vm.imgurl="http://trainingday.cn/fitspt/app/images/xp.jpg",vm.link="https://open.weixin.qq.com/connect/oauth2/authorize?appid=wxe9ccb0a5cdb1b373&redirect_uri=http%3a%2f%2ftrainingday.cn%2ffitspt%2fapp%2fredirect.html%3froute%3dfitexamlist&response_type=code&scope=snsapi_userinfo&state=123#wechat_redirect";var timer=$("timer")[0];ExamSettingFactory.query([],function(resp){vm.size=resp.questions,vm.imgurl="http://trainingday.cn/fitspt/imageshow?id="+resp.shareimg,vm.link=resp.sharelink,vm.sharetitle=resp.sharetitle,vm.sharedesc=resp.sharedesc,vm.timeout=resp.timeout}),UserFactory.getbycode({code:$location.search().code},function(response){vm.user=response}),ShareFactory.query({},function(response){wx.config({debug:!1,appId:response.appId,timestamp:response.timestamp,nonceStr:response.nonceStr,signature:response.signature,jsApiList:["onMenuShareTimeline","onMenuShareAppMessage"]}),wx.hideOptionMenu()}),$scope.resumeTimer=function(){timer.stop()},$scope.startTimer=function(){timer.start(),vm.begin=!1,vm.exam=!0,ExamFactory.query({itype:vm.itype,openid:vm.user.openid},function(response){vm.questions=$filter("randomsort")(response,vm.size),vm.question=vm.questions[vm.index]})},$scope.$on("timer-stopped",function(event,data){0==event.targetScope.countdown?vm.result="timeout":vm.question.choice==vm.question.answer?(vm.result="right",vm.score=vm.score+100/vm.size,0==vm.question.rightflag&&(vm.question.needsave=!0)):vm.result="wrong",vm.index!=vm.size-1&&(event.targetScope.countdown=event.targetScope.countdownattr,event.targetScope.progressBar=0),"timeout"==vm.result?(toastr.warning("超时"),vm.displayanswer=vm.question.answer):"right"==vm.result?(toastr.success("正确"),vm.holdon=1e3):"wrong"==vm.result&&(toastr.error("错误"),vm.holdon=2e3,vm.displayanswer=vm.question.answer),$timeout(function(){toastr.clear()},1e3),$timeout(function(){if(vm.index++,vm.index==vm.size){timer.clear(),toastr.clear(),vm.exam=!1,vm.end=!0;var needsavequestions=_.where(vm.questions,{needsave:!0});ExamFactory.savequestion({questions:JSON.stringify(needsavequestions),openid:vm.user.openid}),wx.ready(function(){wx.showOptionMenu(),vm.sharetitle=vm.sharetitle.replace(/username/g,vm.user.nickname),vm.sharetitle=vm.sharetitle.replace(/score/g,vm.score),LevelFactory.querybyscore({score:vm.score},function(resp){vm.sharetitle=vm.sharetitle.replace(/level/g,resp.name),wx.onMenuShareTimeline({title:vm.sharetitle+","+vm.sharedesc,link:vm.link,imgUrl:vm.imgurl,success:function(){},cancel:function(){}}),wx.onMenuShareAppMessage({title:vm.sharetitle,desc:vm.sharedesc,link:vm.link,imgUrl:vm.imgurl,type:"",dataUrl:"",success:function(){},cancel:function(){}})})})}else vm.question=vm.questions[vm.index],timer.start();vm.displayanswer=""},vm.holdon)}),$scope.tomain=function(){$window.location.href="http://m.trainingday.cn"}});